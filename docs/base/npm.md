> 作者：绯影

### 并行

`npm 5` 以后是并行的，`npm7` 及以后不再提供 `--no-parallel` 这个选项

### .lock 与 npm 的关系

- `npm update` 会更新 `lock` 文件
- `npm install` 时产生 `lock` 文件
- `cnpm install` 不会产生 `lock` 文件
- 当 `package.json` 与 `lock` 文件不兼容时，`npm install` 会更新 `lock` 文件；
- `lock` 兼容 `package.json` 时（`lock` 比较大），使用 `lock`。
- `package.json` 比 `lock` 大时，使用 `package.json`

### peerDependencies

peerDependencies 并不影响最终的安装结果，只是起到一个提示作用

- yarn 里面会提示，但是不会进行阻拦
- npm 里面会提示，同时也会进行安装阻拦。
- pnpm 里面会提示，但是不会进行阻拦

### node_modules

#### npm2.x

嵌套 `node_module`，同样的依赖会复制很多次，`windows` 的文件路径最长是 `260` 多个字符，这样嵌套是会超过 `windows` 路径的长度限制的。还没解决的时候 `yarn` 就出来了

#### yarn

铺平。所有的依赖不再一层层嵌套了，而是全部在同一层，大部分是没有二层 `node_modules` 一个包是可能有多个版本的，提升只能提升一个，所以后面再遇到相同包的不同版本，依然还是用嵌套的方式。

#### npm3.x

和 yarn 很类似

**扁平化**的问题

- 最主要的一个问题是幽灵依赖
  没有显式依赖，也能访问。存在风险，万一有一天别的包不依赖这个包了，那你的代码也就不能跑了。

- 就是上面提到的依赖包有多个版本的时候，只会提升一个，那其余版本的包不还是复制了很多次么

#### pnpm

1. 如果你对同一依赖包需要使用不同的版本，则仅有 版本之间不同的文件会被存储起来。例如，如果某个依赖包包含 100 个文件，其发布了一个新 版本，并且新版本中只有一个文件有修改，则 `pnpm update` 只需要添加一个 新文件到存储中，而不会因为一个文件的修改而保存依赖包的 所有文件。

2. 所有文件都保存在硬盘上的统一的位置。当安装软件包时， 其包含的所有文件都会硬链接自此位置，而不会占用 额外的硬盘空间。这让你可以在项目之间方便地共享相同版本的 依赖包。然后包和包之间的依赖关系是通过软链接组织的。
   `node_modules`下面的包以及 `node_modules/.pnpm/xx/node_modules` 里面的包 软链接到 `node_modules/.pnpm`

**可以解决**

- `node_modules` 下只有显式安装的包，没有幽灵依赖
- 包和包之间的依赖关系是通过软链接组织的。
- 多个项目中相同的依赖将与全局 `store` 里面的内容建立硬链接（`npm、yarn`都是每个项目安装完整的引用包）
